# kurs-devops

### Решение Задачи  
- Все поставленные задачи решаются через запуск terraform (terraform apply)
- Сруктура проекта терраформ следующая:
  - main.tf - в нем создаются необходимые ВМ для сервисов, расписание snapshots и выходные данные (IP адреса) для ВМ, задаются локальные значения для создания ВМ (locals), указываются дополнительные провадеры необходимые для работы (null, time)
  - network.tf - здесь описывается вся сетевая инфраструктура - создается сеть (network-1) и подсети (subnet-1,2,3,4) в соответсвии с заданием
  - security_groups.tf - описываются группы безопасности
  - alb.tf - создается Балансировщик L-7
  - ansible.tf - отсюда передаются пепеменные и запускаются конфигурации (playbook) ansible, на основе провайдера null (provisioner "local-exec"), подробная работа ansible описана ниже
  - variables.tf - здесь объявляются необходмивые переменные для работы выше описанных ресурсов
  - terraform.tfvars - здесь хранятся чувствительные данные - токены и пароли
  - каталог meta - содержит мета данные для ВМ

- Структура Ansible
  - В папке ansible хранятся плейбуки для настройки сервисов, каждый плейбук запускается из terraform через провайдера null и передает через параметр --extra-vars необходиммые данные для работы разворачиваемых сервисов (это IP адреса, имена и пароли)
  - Подключение ко всем ВМ происходит через bastion host, как того требудет задание. Для этого в конфигурации Ansible, в инвентори, используется параметр ansible_ssh_common_args с опция конфигурации SSH - ProxyCommand
  - В самих плейбуках соответвтвено их наименованиям описана конфигурация сервисов описанных в задании курсовой работы
  - Также в папке ansible присутствуют еще 2 дирректории templates и files
      - В files расположенны статичные конфигурации которые подгружаются из плейбуков для работы соответствующих сервисов
      - В templates - расположены шаблоны Jinja2 - динамически изменяемые файлы с использованием данных, переданных из Ansible (--extra-vars)


### Настройка для работы:  
- Создание и настройка инфраструкты происходит по запуску terraform (terraform apply) из terraform происходит в частности и запуск плейбуков ansible
- Для работы необходимо указать данные в файле terraform.tfvars: yandex_cloud_token, elastic_passwd и grafana_passwd
- В файле user-data.yaml необходимо указать публичный ключ, а в папку ansible положить соответствующий приватный ключ и указать его имя в ansible.cfg, так же приватный ключ должен быть и в обычном расположении ~/.ssh
- Для входа в grafana пользователь - admin, kibana - elastic
- На всех ВМ пользователь - stas, в Ansible inventory.ini и ansible.cfg соответвенно тоже указавается пользователь - stas

### Дополнительные настройки:  
- В файле variables.tf можно настроить характеристики ВМ
- Также variables.tf можно ужесточить политику безопасности, но только после создания всей инфраструктуры, для этого нужно для Переменной управления средой применить default = true и снова запустить terraform apply
- При создании ВМ в файле main.tf можно использовать статические IP. Для этого нужно добавить ключ для IP в locals и раскоментировать ip_address = each.value.ip в блоке network_interface

### Результаты работы:
Работающая инфраструктура рассходует денежные средства, поэтому представляю только данные о ее работе.  
Если в ходе провери задания потребуется показать работу, то развертка занимает не дольше 10 минут и может быть осуществлена по предварительной договоренности.  

Лог создания ресурсов terraform и настройки ansible представлен в файле:  
[worklog](results/worklog)  

Скриншоты:
![VM](results/VM.png)
![ALB](results/ALB.png)
![VPC](results/VPC.png)
![grafana](results/grafana.png)
![kibana.png](results/kibana.png)
![webserv1](results/webserv1.png)
![webserv2](results/webserv2.png)
